apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: model-retraining-pipeline
  namespace: kubeflow
spec:
  entrypoint: retraining-pipeline
  templates:
  - name: retraining-pipeline
    steps:
    - - name: data-prep
        template: data-preparation
    - - name: training
        template: model-training
        arguments:
          artifacts:
          - name: data
            from: "{{steps.data-prep.outputs.artifacts.data}}"
    - - name: evaluation
        template: model-evaluation
        arguments:
          artifacts:
          - name: model
            from: "{{steps.training.outputs.artifacts.model}}"
    - - name: register
        template: model-register
        when: "{{steps.evaluation.outputs.parameters.is-better}} == true"
        arguments:
          artifacts:
          - name: model
            from: "{{steps.training.outputs.artifacts.model}}"
  
  - name: data-preparation
    container:
      image: python:3.11
      command: [python, -c]
      args:
      - |
        import boto3
        import pandas as pd
        # Download from MinIO, preprocess, save
        print("Data preparation completed")
      outputs:
        artifacts:
        - name: data
          path: /tmp/data
          s3:
            endpoint: minio:9000
            bucket: training-data
  
  - name: model-training
    inputs:
      artifacts:
      - name: data
        path: /tmp/data
    container:
      image: pytorch/pytorch:2.1.0-cuda11.8-cudnn8-runtime
      command: [python, /app/train.py]
      args: ["--data-dir", "/tmp/data", "--output", "/tmp/model"]
      resources:
        limits:
          nvidia.com/gpu: 1
      outputs:
        artifacts:
        - name: model
          path: /tmp/model
  
  - name: model-evaluation
    inputs:
      artifacts:
      - name: model
        path: /tmp/model
    container:
      image: python:3.11
      command: [python, -c]
      args:
      - |
        # Evaluate model, compare with baseline
        accuracy = 0.85
        baseline = 0.80
        is_better = accuracy > baseline
        print(f"Model accuracy: {accuracy}, Better: {is_better}")
      outputs:
        parameters:
        - name: is-better
          valueFrom:
            path: /tmp/is-better.txt

